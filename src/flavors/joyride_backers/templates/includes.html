<script src="{{ STATIC_URL }}libs/md5.js"></script>
<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css">
<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>

<script>
  $(function() {
  
    var S = Shareabouts;
    
    function getPossibleCityData(enteredName, callback) {
      // 1. Get a standardized name
      $.ajax({
        url: '/geocode',
        type: 'GET',
        data: {location: enteredName, flags: 'J'},
        success: function(data, status, $xhr) {
          var results = data.bossresponse.placefinder.results;
          
          citiesData = _.map(results, function(result) {
              return {
                name: result.city + ', ' + result.state + ', ' + result.country,
                quality: result.quality,
                location: {lat: result.latitude, lng: result.longitude}
              };
            });
          
          callback(citiesData);
        }
      });
    }
    
    function getPlaceForCityName(cityName, cityData, code, foundPlaceCallback) {
      var cities = window.app.collection,
          latitude = cityData.latitude,
          longitude = cityData.longitude,
          city;
      
      // 2. Ask the user whether that's the city they meant

      // 3. If so, look for a city with that name
      city = cities.find(function(p) { return p.name == cityName; });
      
      if (city) {
        foundPlaceCallback(city);
      }

      // 4. If you don't find a city, add one
      if (!city) {
        city = cities.create({
          'name': cityName,
          'location': cityData.location,
          'location_type': 'city',
          'visible': true,
          'write_code': code
        }, {
          success: function(newCityData, resp) {
            var newCity = cities.get(newCityData.id);
            foundPlaceCallback(newCity);
          },
          wait: true // we don't want to trigger the normal add
        });
      }
    }
    
    function addBackerToCity(city, backerData, options) {
      city.responseCollection.create(backerData, options);
    }
    
    $('#content').delegate('#backer-add-form', 'submit', function(evt) {
      evt.preventDefault();
      
      var $form = $('#backer-add-form'),
          $cityName = $form.find('#city'),
          submitterName = $form.find('#backer-submitter_name').val(),
          cityName = $form.find('#backer-city').val(),
          cityData = $form.find('#backer-city').autocomplete('option', cityName),
          url = $form.find('#backer-url').val(),
          code = $form.find('#backer-code').val(),
          
          backerData = {
            'submitter_name': submitterName,
            'backer_url': url,
            'visible': true,
            'write_code': code
          };
      
      getPlaceForCityName(cityName, cityData, code, function(city) {
        // 5. Add backer to the city
        city.responseCollection.create(backerData);
      });
    });
  
    // Set up autocomplete for the city name.  Since the box may be destroyed 
    // and recreated, initialize it as an auto-complete box each time it 
    // receives focus.
    function getCityAutocompleteChoices(request, response) {
      var $cityName = this;
      
      getPossibleCityData(request.term, function(citiesData) {
        var choices = _.pluck(citiesData, 'name'),
            options = {};
        
        _.map(citiesData, function(cityData) {
          options[cityData['name']] = cityData;
        });
        
        $cityName.autocomplete('option', options);
        response(choices);
      });
    }
              
    $('#content').delegate('#backer-city', 'focus', function(evt) {
      var $cityName = $('#backer-city');
      
      $cityName.autocomplete({
        source: _.bind(getCityAutocompleteChoices, $cityName),
        autoFocus: true
      });
    });
    
  });
</script>
