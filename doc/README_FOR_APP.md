# Installing Shareabouts 

### Shareabouts requirements
* Ruby 1.9.2
* PostGIS (see below)
* [ogr2ogr](https://github.com/openplans/shareabouts/wiki/Shapefiles)
* ImageMagick (see below)

### Optional
* facebook and twitter API keys for authentication

# Installation (see steps below)
1. Install the above requirements.
2. Set up your Rails App
3. Start the Server or Deploy the app to a production environment. 
4. Set up the initial Admin user.
5. Set Site Options and Customize your app.

# Installation: Rails App

Shareabouts is a [Ruby on Rails](http://guides.rubyonrails.org) app. There are a few setup steps that need to be taken to get any Rails app up and running. 

## Gems
Install your gems by running `$ bundle install` from your checked out app's root directory.

### Tips
1. If the pg gem fails to install on OS X, check out the --with-pg-config option 
as specified in config/database.yml.example.

## Databases
Copy config/database.yml.example to config/database.yml. Set your postgres 
server and user info. You'll need to specify the template to use in order to
get the spatial goodies:
  template: template_postgis

Also change the database username and password as needed.

Note that you need to check the config for *all* databases --
development, test, and (if you're setting up a production server) production.

Now you can run

`$ rake db:create`

and

`$ rake db:migrate`

Finally, seed the database with an initial admin user and other data:

`$ rake db:seed`

### Tips
1. Do not use db:schema:load or db:setup, as ruby that is generated in schema.rb 
does not accurately reflect the state of the database generated by db:migrate.
2. `rake db:seed` runs the script found at db/seeds.rb. It contains an initial [[Admin]] user whose credentials should be changed immediately on any publicly accessible site. See the [[Admin]] page for more information.

## Testing

We use Rspec for testing, so you can run the tests from your app's root directory with `$ rake spec`.

# Installation: Development and Production Servers

## Starting the Development Server

In the root of your shareabouts checkout, run this:

`$ rails server`

## Production Server Setup

We recommend using a cloud host to deploy your app, as many are geared toward deploying rails apps and provide excellent support. Check out the following sections for Engine Yard, Dotcloud and Heroku instructions.

### Apache

If you want to role your own Apache server, check out [this guide](http://kris.me.uk/2011/10/28/rails-rvm-passenger-capistrano-git-apache.html) on setting up your app to run on Apache with passenger. 

# Installation: Deploying to production

You can skip this if you're only doing local development or if you're 
deploying to Dotcloud or Engine Yard or another cloud platform. We recommend using a cloud host to deploy your app, as many are geared toward deploying rails apps and provide excellent support. Check out the following guides for:

1. Engine Yard
2. Dotcloud
3. Webfaction

Note that we have not been able to get Heroku working as a cloud platform as it doesn't (yet) have a spatial database available for general use; it's in private beta as of spring 2012.

## Capistrano

We deploy to our staging and production servers with [capistrano](https://github.com/capistrano/capistrano/wiki/). Our deploy script is config/deploy.rb. We deploy to 
multiple environments, so we have a production.rb and staging.rb deploy script
in config/deploy, which contain server- and environment- specific variables, 
such as :domain, :user, and :deploy_to.

To create the initial capistrano setup run:

`$ cap deploy:setup`

Then, on the deployment server, go into the 'shared' directory under
your deploy_to directory. Put your customized config/database.yml,
config/facebook.yml and config/twitter.yml into shared, preserving the config
directory structure.

On your local machine you should be able to run

`$ cap deploy:migrations`

which will deploy the app and run pending migrations. Whenever deploying with 
pending migrations, use deploy:migrations. If there are no migrations, 
cap deploy will do.

Make sure to run RAILS_ENV=production rake db:seed from the current release 
directory in order to create the initial [[Site Options]] and [[Admin]] user. 
**IT IS VERY IMPORTANT** to change the credentials for the generated Admin user. 
Visit http://SITEURL/admin, log in with the default credentials, click 
"Admins" in the left nav, and click "Edit" on the line of the generated admin.
Enter the email address, new password, and password again (under Password 
Confirmation) and click Save. 

## Engine Yard

A very abbreviated guide to getting Shareabouts set up on [EngineYard Cloud](https://cloud.engineyard.com).

1. set up a new app and follow instructions accordingly until environment is set up
2. stop instance
3. click "edit environment":
  1. application server stack:  passenger 3
  2. runtime: ruby 1.9.2
  3. database stack:		postgreSQL 9.1.x
  4. click "update environment"
4. click "boot"
5. click "Tools" > "SSH Public Keys"
  1. add your local public key (usually in ~/.ssh/id_rsa.pub)
6. on the Environment page, click "Apply"
7. copy ssh link under Instances and ssh in (ie. ssh deploy@ec2-XX-XX-XXX-XX.compute-1.amazonaws.com)
8. Enter the following commands on the server in order to install geos, proj, gdal, and postgis:

        mkdir sources
        cd sources
        wget http://download.osgeo.org/geos/geos-3.3.2.tar.bz2
        tar -xjf geos-3.3.2.tar.bz2
        cd geos-3.3.2
        ./configure
        make && sudo make install
        cd ..
        wget http://download.osgeo.org/proj/proj-4.7.0.tar.gz
        tar -zxvf proj-4.7.0.tar.gz
        cd proj-4.7.0
        ./configure
        make && sudo make install
        cd ..
        wget Â http://download.osgeo.org/gdal/gdal-1.9.0.tar.gz
        tar -zxvf gdal-1.9.0.tar.gz
        cd gdal-1.9.0
        ./configure
        make && sudo make install
        wget http://postgis.refractions.net/download/postgis-1.5.3.tar.gz
        tar -zxvf postgis-1.5.3.tar.gz
        cd postgis-1.5.3
        ./configure
        make && sudo make install
        sudo ldconfig
        cd
        sudo su postgres
        psql -d [YOUR_DATABASE]
        CREATE LANGUAGE plpgsql;
        \i /usr/share/postgresql-9.1/contrib/postgis-1.5/postgis.sql
        \i /usr/share/postgresql-9.1/contrib/postgis-1.5/spatial_ref_sys.sql
        GRANT ALL ON geometry_columns TO PUBLIC;
        GRANT ALL ON geography_columns TO PUBLIC;
        GRANT ALL ON spatial_ref_sys TO PUBLIC;
        VACUUM FREEZE;
        \q
        exit

9. On the Dashboard, deploy with db:migrate
10. On your local machine, enter the following commands to install the chef recipe to restart delayed jobs on the server:

        git clone https://github.com/openplans/ey-cloud-recipes
        cd ey-cloud-recipes
        gem install engineyard
        ey-recipes upload -e production && ey-recipes apply -e production

11. SSH into the server and then:

        cd /data/[APP_NAME]/current
        rake db:seed

## Deploying Shareabouts on dotcloud.com

### Preparation

0. Read about the difference between [live and sandbox flavors on Dotcloud](http://docs.dotcloud.com/guides/flavors/)
1. Get a dotcloud API key.
2. Install the dotcloud command line app.
3. Get a Facebook app ID and secret, and a Twitter consumer key and secret; see Authentication.
4. Clone the Shareabouts source from github.

### First Deployment

From the root of your shareabouts source tree:

    dotcloud create shareabouts

Now do your first deployment. This will take a few minutes:

    dotcloud push shareabouts .

**Or** if you are deploying from a branch:

    dotcloud push -b <branchname> shareabouts .

If you're deploying to the live flavor (because you ran _dotcloud create -f live shareabouts_), the deployment might fail because of a lack of memory. You won't get a friendly error, it just fails. Increase memory and try again: 

    dotcloud scale shareabouts  www:memory=512M

Note that you may see messages like:

    "fatal: Not a git repository"

It's safe to ignore these.

Our dotcloud configuration requires some variables set in the dotcloud environment file; these have to be done after the first push. It's best to do this in one command because each time you run ``dotcloud var set``, it triggers a new deployment - which is fine, but this is faster:

    dotcloud var set shareabouts FACEBOOK_APP_ID=<your facebook app id> \
       FACEBOOK_APP_SECRET=<your facebook app secret> \
       TWITTER_CONSUMER_KEY=<your twitter consumer key> \
       TWITTER_CONSUMER_SECRET=<your twitter consumer secret


Now create and seed the database:

    dotcloud run shareabouts.www -- rake -f current/Rakefile db:create db:migrate db:seed

That should take care of everything.

Note that if you have local changes to your shareabouts code,
you must commit them before running ``dotcloud push``.

If the build finishes but you get errors from the server, ssh in (by
doing ``dotcloud ssh shareabouts.www``) and check
/home/dotcloud/current/log/production.log

## Pushing Updates

From the root of your shareabouts source tree:

    dotcloud push shareabouts .
    dotcloud run shareabouts.www -- rake -f current/Rakefile db:migrate

## How it works

Our dotcloud config file is in ``dotcloud.yml``.
See http://docs.dotcloud.com/guides/build-file/ for information about these files.

After each ``dotcloud push``, the ``postinstall`` script is automatically run.
See http://docs.dotcloud.com/guides/hooks/ for more about postinstall scripts.

## Installing on Webfaction

Not a "cloud" solution per se, but Shareabouts seems to run well on webfaction.com shared hosting,
as long as you get some extra RAM (512 MB should do it for light hosting).

Basic setup
----------------

Control panel: Create new Postgresql database.
Control panel: Open a new support ticket asking for PostGIS to be
enabled on your new database. Be sure to tell them the database name.
They are usually pretty quick about this. If you want to install PostGIS 2.0, you can create a custom app, and install PostGres 9.1/PostGIS 2.0. Then no support ticket is required.

While waiting for that to get done, you can do the rest:

Control panel: Create a new application.
Select "Passenger" as the type. (NOT rails!)
Specify the name.

Create a new "Website". Configure it to use the domain or subdomain,
and the app you created in the previous step.

ssh to your server and cd to ~/webapps/YOUR-APP-NAME

Notice there is a hello_world app.

Browse to http://YOUR-DOMAIN and verify you see "hello world".  If
not, re-check the steps above, get support from webfaction if
necessary.


Install shareabouts
--------------------

In this version we're not showing how to do capistrano deployments,
we're just checking out the source and wiring it up to nginx by hand.

ssh to the server.

First, you need imagemagick. See http://docs.webfaction.com/software/rails.html#installing-imagemagick-and-rmagick
That will take a while to build. Ten minutes?
NOTE be sure to update your $PATH as described there:

```bash
 echo "export PATH=$HOME/bin:\$PATH" >> ~/.bash_profile
```

You can skip the rmagic part, you'll do that in a minute.

When it's done: Now get the shareabouts source code.

```bash
cd ~/<your_app_name>
git clone https://github.com/openplans/shareabouts.git

export GEM_HOME=$PWD/gems
export RUBYLIB=$PWD/lib
export PATH=$PWD/bin:$HOME/bin:$PATH
export LD_LIBRARY_PATH=$HOME/lib
export PKG_CONFIG_PATH=$HOME/lib/pkgconfig/

cd shareabouts
gem install bundler
bundle install
```

Make sure that command exits without errors before proceeding.

Configure nginx
--------------------

```bash
# Use favorite editor...
vi nginx/conf/nginx.conf
```
Change `server { root }` to point to
`/home/<YOUR ACCOUNT>/webapps/<YOUR APP>/shareabouts/public`

Next you'll want to add one option to avoid running out of RAM.
This seems to limit it to a peak of about 400MB.
You'll want to spend the extra $7/month to get a 512MB limit
(pricing as of july 2012). In nginx.conf, find the http section, and add this:

```
   passenger_max_pool_size 3
```

This limits how many concurrent users you can quickly handle; but 
initial testing suggests this should be fine for typical shareabouts
deployments that we've seen, and doesn't seem to hurt performance.
Probably if performance isn't adequate at this level, you need something more
heavy-duty than a shared hosting solution anyway.

If you want to know how much of your RAM allocation you're using, try
this command:

```bash
ps -u $USER -o rss,command | grep -v peruser | awk '{sum+=$1} END {print sum/1024}'
```



Configure database
----------------------

cd to the shareabouts tree
and create config/database.yml, put in your db info
(check your email, see if your support ticket got addressed yet).

cd to root of shareabouts

```bash
export RAILS_ENV=production
bundle exec rake assets:precompile
bundle exec rake db:migrate
bundle exec rake db:seed
```

Start it up!
--------------

Restart nginx:

```bash
cd $HOME/webapps/<appname>
bin/restart
```

Browse to http://YOUR-DOMAIN
It should work.
If errors, see `shareabouts/log/production.log`

Otherwise, login to http://.../admin as admin@example.com 
with the default password (p@ssw0rd) and reset the admin
password immediately :)

## Heroku

The [Heroku buildpack for Ruby GEOS](https://github.com/ryandotsmith/heroku-buildpack-ruby-geos) will vendor [GEOS](http://trac.osgeo.org/geos/) on heroku. Create an app with this buildpack and provision a database with postgis support to get Shareabouts up and running on [Heroku](http://heroku.com). 

Capistrano?
--------------

If you want to do capistrano on webfaction, see
http://docs.webfaction.com/software/rails.html#deploying-a-ruby-on-rails-application-with-capistrano

Shapefiles and Delayed jobs
=============================

If you are going to upload any shapefiles, they won't get processed
until you run this command from the root of your checkout:

```bash
 RAILS_ENV=production script/delayed_job start
```

If it doesn't seem to work, check the log file at
(from the root of your checkout) logs/delayed_job.log


Upgrades
=========

Without capistrano, updating your code is a little bit more work.

First you'll want to permanently put the GEM_HOME environment from above
in your ~/.bash_profile:

```bash
export GEM_HOME=$HOME/webapps/YOUR-APP-NAME/gems
```

Then each update goes like this:

```bash
cd  $HOME/webapps/YOUR-APP-NAME/shareabouts
git pull
export RAILS_ENV=production
bundle exec rake assets:precompile # need that or your CSS changes won't take effect
bundle exec rake db:migrate  # only really needed if models have changed
~/webapps/YOUR-APP-NAME/bin/restart
```


# Initial Admin and Site Options
The seed script, located at db/seeds.rb, will generate the initial [[Site Options]]
and Admin user. Run the script:

`$ rake db:seed`

It is **VERY IMPORTANT** to update the credentials for the generated Admin user 
after you start up the server (see "Starting the Development Server"). 

1. Visit http://0.0.0.0:3000/admin (or whatever the address for your server is)
2. Sign in with the default credentials found in db/seeds.rb.
3. Click the email address in the upper right corner. 
4. Enter your email address, new password, and password again (under Password Confirmation) and 
click Save.

In Site Options, create the following:
* _google_analytics_code_ enter the full Google Analytics snippet, including the script tag (not just your analytics id)
* map_bounds_p1_lat
* map_bounds_p1_long	
* map_bounds_p2_lat	
* map_bounds_p2_long
* map_center_lat	
* map_center_long
* map_initial_zoom	
* map_max_zoom
* map_min_zoom


# Customizing Shareabouts after install

## Admin Interface
Shareabouts uses the [rails_admin](https://github.com/sferik/rails_admin) engine for some management tasks.

You can use the admin interface to:

1. Create new and edit existing admins (/admin/admin).
2. Create static pages (/admin/page).
3. Upload [[Shapefiles]] that represent regions (/admin/shapefiles) or FeaturePolygons (/admin/feature_polygon).
4. Manage comments (/admin/comments).
5. Manage submitted FeaturePoints (/admin/feature_point).
6. Create and manage LocationTypes (/admin/location_type).
7. Set the [[Site Options]].

## Adding users
Add new users at /admin/admin/new.

Set Level to 100 for admin users - they can change Site Options and create new users.

Level 0 users can't change options. This is the default user level.


## Customizing Shareabouts

### Location types and custom markers

Admins have the ability to create custom types for locations in the admin section. 

Optionally, admins can set a custom image that can be used to represent the type, e.g. in the popup for the selected location. 

Additionally, admins can optionally set marker options for the image, indicating locations of the given type will be represented on the map by the image. 

#### To create a location type without a custom marker:

1. Log into /admin.
2. Click "Location Types" on the side nav.
3. Click "Add New" in the tabbed nav, or click "Edit" for an existing location type.
4. Provide a Name for the type.
5. Optionally, choose an image for the location type. 
6. **Click the "Remove" button in the Marker section of the form**.
7. Click "Save." 

#### To create a location type with a custom marker:

1. Navigate to the Location Type form as indicated above.
2. Provide a name for the location type.
3. Choose an image for the location type. This image should already be sized to the size it will be on the map.
4. Enter the attributes for the markers (if you do not do this, your icons will not show up on the map):
    * **Icon width**: the width of the image you're uploading.
    * **Icon height**: the height of the image you're uploading.
    * **Icon anchor x**: the x coordinate of the "tip" of the icon, relative to its top left corner. The icon will be aligned so that this point is at the marker's geographical location.
    * **Icon anchor y**: the y coordinate of the "tip" of the icon.
    * **Popup anchor x**: the x distance, in pixels, from which the marker popup opens, relative to the anchor point.
    * **Popup anchor y**: the y distance, in pixels, from which the marker popup opens, relative to the anchor point.
5. Save.

### Adding extra layers to the map

If you want to show an extra layer on the map (e.g. bike network, rail lines, parks), edit /app/assets/javascripts/main.js.erb. Find the onload callback function (should be around line 69), and add any supported [Leaflet](http://leaflet.cloudmade.com/reference.html) layer. For example:

        onload : function() {
          // Get the Leaflet map object
          var map = Map.shareabout('getMap');
          // Add the custom layer
          map.addLayer( /* your leaflet layer here */ );

          // ... rest of the function
        },

Note is the current Leaflet documentation is for version 0.4 while Shareabouts is still using 0.3.


### Changing the default copy

Shareabouts' interface copy is stored in the en.yml localization file, stored in shareabouts / config / locales / en.yml.

Edit this file to change the default copy for the site:
* site title
* UI text (e.g. text for the add point button, "drag me" cues)
* message after adding to the map (e.g. "Thanks for suggesting a new playpark location!")
* twitter message (e.g. "I suggested a play park!")
* etc.

# Shapefiles

Shareabouts allows admins to upload shapefiles. Shapefiles are currently used in two ways:

1. The Shapefile model (accessible in the admin interface at http://APP_ROOT/admin/shapefile) is used to create a number Regions. Regions currently are only used to classify the location of a point. So regions might represent neighborhoods, boroughs, states, etc.
2. FeaturePolygons are multipolygons an admin can upload and indicate as being visible as a map feature. While admins can currently upload FeaturePolygons (accessible in the admin interface at http://APP_ROOT/admin/feature_polygon), their display on the map is not yet implemented. 

Shapefile reprojection
----------------------
1. We drop down to use the command line tool, [ogr2ogr](http://www.gdal.org/ogr2ogr.html), in order to reproject imported shapefiles, so you'll need ogr2og2 installed wherever you're running the app.

2. Shapefiles are unpacked and reprojected via a [delayed job](https://github.com/collectiveidea/delayed_job), so you'll need to start up delayed_jobs via: `$ script/delayed_job start`. The job scripts can be found in lib/jobs.

### Tips
1. The deploy script will start and restart delayed jobs for you so you should only need to start the delayed jobs locally for development. 
2. Currently $LD_LIBRARY_PATH is explicitly set in lib/jobs/shapefile_import_helper.rb to find ogr2ogr. We intend to take this out, as everyone's paths vary, but you might need to modify this line or remove it yourself while it remains in the project.

# Authentication

Shareabouts uses [Facebook](https://developers.facebook.com/apps) and/or [Twitter](https://dev.twitter.com/apps) for authentication, via the [omniauth gem](https://github.com/intridea/omniauth). You'll need to generate app keys and secrets at the above URLs.

On Twitter's settings page for your app, you must enter the Callback
URL.  This should be set to your site's public URL followed by "/auth/twitter".
For Access, you can choose "Read only".

Once you have those keys, copy config/facebook.yml.example to config/facebook.yml, 
and copy config/twitter.yml.example to config/twitter.yml. Then, fill in your keys 
for each environment for each service.

### Tips
1. Be sure to restart your app whenever you update the authentication keys, as the keys are loaded at boot.

# Image Magick

We use [paperclip](https://github.com/thoughtbot/paperclip) to handle attachments, and under the hood, paperclip uses [ImageMagick](http://www.imagemagick.org) to convert images to different sizes. 

### Tips
1. The rmagick gem requires the Imagemagick development libraries.
  1. If installing ImageMagick from source, configure your build with the following flags: `$ ./configure --disable-static --with-modules --without-perl --without-magick-plus-plus --with-quantum-depth=8`.
  2. On Debian or Ubuntu, try: `$ apt-get install libmagickwand-dev`.

# PostGIS

To run Shareabouts, you'll need [postGIS](http://postgis.refractions.net) set up on top of [postgres](http://www.postgresql.org). PostGIS allows us to do advanced spatial queries and natively represent geometry types in the database.

You can install postgis via a package manager like apt-get or macports. See the tips below.

After installing postgres and postgis, depending on your system, you may need to to run scripts to set 
up postgis. Follow the instructions given after installation.

Now, create a template spatial database that you can use for your shareabouts database.

To check if you need to create the template:

`$ psql -l | grep template_postgis`

If that turns up nothing, run the following sql commands in psql. Be sure to change the paths to your postgis sql files if applicable.

    -- Create a new database
    CREATE DATABASE template_postgis;
    
    -- Make it a template database
    UPDATE pg_database SET datistemplate = TRUE WHERE datname = 'template_postgis';
    
    -- Connect to new database and install the pl/pgsql language
    \c template_postgis
    
    CREATE LANGUAGE plpgsql;
    
    -- Install PostGIS (your file paths may vary)
    \i /opt/local/share/postgresql84/contrib/postgis-1.5/postgis.sql 
    \i /opt/local/share/postgresql84/contrib/postgis-1.5/spatial_ref_sys.sql
    GRANT ALL ON geometry_columns TO PUBLIC;
    GRANT ALL ON geography_columns TO PUBLIC;
    GRANT ALL ON spatial_ref_sys TO PUBLIC;
    
    -- vacuum freeze: it will guarantee that all rows in the database are
    -- "frozen" and will not be subject to transaction ID wraparound
    -- problems.
    VACUUM FREEZE;

### Tips
* If using macports, install the postgresql91-server port before installing postgis. 
* If when following the post-install instructions on OS X and setting up the initial database you get a fatal memory allocation error, see [this post](http://willbryant.net/software/mac_os_x/postgres_initdb_fatal_shared_memory_error_on_leopard)

# Ruby 1.9.2

Shareabouts was built on top of ruby 1.9.2.

The easiest way to get ruby is via [rvm](https://rvm.beginrescueend.com).  rvm requires git, so install git first.  Then follow the rvm installation instructions, preferably the [single-user approach](https://rvm.beginrescueend.com/rvm/install).

Then install ruby 1.9.2:

`$ rvm install 1.9.2`

Now to use 1.9.2:

`$ rvm use 1.9.2`

Or to use ruby 1.9.2 always, run:

`$ rvm use 1.9.2 --default`

### Tips
* Don't forget to edit your .profile (or .bash_profile, or whatever) as per the instructions!
* It is generally NOT recommended to use a system-specific package system such as apt-get, rpm, etc. to install rvm.  Doing so will probably set up a multi-user version of rvm and may make the rest of these instructions fail.
* On Ubuntu, if you get compile errors like "SSLv2_client_methodâ undeclared here", you may need to follow [these instructions](http://29a.ch/2011/10/28/rvm-on-ubuntu-11-10) to get the right SSL library installed. But also note that doing a single-user install of rvm may "just work".

Feedback
--------
If you run into any problems setting up the app or find that this document 
lacks something, please get in touch with us on our [mailing list] (http://groups.google.com/group/shareabouts-dev). Also feel free to contribute to this wiki yourself :)

# Known Issues 
* Can't edit page slug
* google gets stuck on the browser selection page
* admin can't upload images 
* Comments scroll over popup text
* iPhone message - shareabouts doesn't work in this version of Safari
* closing "filter by popularity" tray doesn't reset filter
* Admins should be able to delete location type markers
* "drag-me" tip should only disappear when marker is clicked/dragged, not when map is dragged (as marker's lat/lon doesn't change). 
* User should get error message if Error in POST to locations gives 500 error
* After sign in, user avatar is weirdly sized
* (Shareabouts Staging Exception) sessions#new (ActionView::MissingTemplate) "Missing template users/sessions/new with {:h...
* (Shareabouts Production Exception) votes#destroy (NoMethodError) "undefined method `supportable' for nil:NilClass"
